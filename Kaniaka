import telebot
from telebot import types
import time
import random
import json
import sympy as sp
import urllib.parse

TOKEN = "8478534243:AAGeQww_tJpqAkrd-56XG5h0ua1RlfrDubg"
bot = telebot.TeleBot(TOKEN)
DATA_FILE = "users.json"
COMMISSION = 0.15
PREFIXES = ("/", ".", "!", "—Å–∞–ø")
ADMIN_IDS = ["1573577653"]

# ---------------- utils ----------------
def load():
    try:
        with open(DATA_FILE,"r",encoding="utf-8") as f:
            return json.load(f)
    except:
        return {}

def save(data):
    with open(DATA_FILE,"w",encoding="utf-8") as f:
        json.dump(data,f,ensure_ascii=False,indent=2)

users = load()

def uid(m): return str(m.from_user.id)

def get(u):
    if u not in users:
        users[u] = {
            "coins":0,
            "farm_cd":0,
            "daily_streak":0,
            "last_daily_ts":0,
            "daily_missed_ts":0,
            "advent":[],
            "log":[],
        }
    return users[u]

def save_all():
    save(users)

def is_cmd(text, cmd):
    return text.lower().startswith(tuple(p + cmd for p in PREFIXES))

def is_admin(m):
    return str(m.from_user.id) in ADMIN_IDS

# ---------------- —Ñ–∞—Ä–º ----------------
@bot.message_handler(func=lambda m: is_cmd(m.text,"—Ñ–∞—Ä–º"))
def farm(m):
    u = get(uid(m))
    now = time.time()
    if now < u["farm_cd"]:
        left = int((u["farm_cd"] - now)//60)
        bot.send_message(m.chat.id,f"‚è≥ –§–∞—Ä–º –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ {left} –º–∏–Ω.")
        return
    luck = random.randint(1,100)
    if luck<=5:
        coins=random.randint(50,100)
        text=f"üçÄ –£–î–ê–ß–ê!\nüåë +{coins} –∫–æ–∏–Ω–æ–≤ –≤ –º–µ—à–æ–∫"
    else:
        coins=random.randint(5,50)
        text=f"üåë –ó–ê–ß–Å–¢!\n+{coins} –∫–æ–∏–Ω–æ–≤ –≤ –º–µ—à–æ–∫"
    u["coins"]+=coins
    u["farm_cd"]=now+10800
    save_all()
    bot.send_message(m.chat.id,text)

# ---------------- –º–µ—à–æ–∫ ----------------
@bot.message_handler(func=lambda m: is_cmd(m.text,"–º–µ—à–æ–∫"))
def bag(m):
    u=get(uid(m))
    bot.send_message(m.chat.id,f"üí∞ –í –º–µ—à–∫–µ: {u['coins']} üåë")

# ---------------- –µ–∂–µ–¥–Ω–µ–≤–∫–∞ ----------------
@bot.message_handler(func=lambda m: is_cmd(m.text,"–µ–∂–µ–¥–Ω–µ–≤–∫–∞"))
def daily(m):
    u=get(uid(m))
    now=int(time.time())
    if now - u["last_daily_ts"] < 86400:
        missed = (now - u["last_daily_ts"]) > 172800
        if missed:
            kb=types.InlineKeyboardMarkup()
            cost=int(u["daily_streak"]*10000*1.05)
            kb.add(types.InlineKeyboardButton(f"üî• –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∏–∫ –∑–∞ {cost} üåë",callback_data=f"restore:{uid(m)}"))
            bot.send_message(m.chat.id,"‚ùå –°—Ç—Ä–∏–∫ –ø—Ä–æ–ø—É—â–µ–Ω! –ú–æ–∂–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:",reply_markup=kb)
            return
        else:
            bot.send_message(m.chat.id,"‚ùå –£–∂–µ –ø–æ–ª—É—á–∞–ª–∏ –Ω–∞–≥—Ä–∞–¥—É —Å–µ–≥–æ–¥–Ω—è")
            return
    u["daily_streak"]+=1
    u["last_daily_ts"]=now
    coins=random.randint(50,120)
    text=f"üéÅ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è –Ω–∞–≥—Ä–∞–¥–∞\nüî• –°—Ç—Ä–∏–∫: {u['daily_streak']} üî•\n+{coins} üåë"
    u["coins"]+=coins
    save_all()
    bot.send_message(m.chat.id,text)

@bot.callback_query_handler(func=lambda c:c.data.startswith("restore:"))
def restore_streak_cb(c):
    _, owner = c.data.split(":")
    if str(c.from_user.id) != owner:
        bot.answer_callback_query(c.id,"‚ùå –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å",show_alert=True)
        return
    u=get(owner)
    cost=int(u["daily_streak"]*10000*1.05)
    if u["coins"]<cost:
        bot.answer_callback_query(c.id,f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–∏–Ω–æ–≤ ({cost})",show_alert=True)
        return
    u["coins"]-=cost
    u["daily_streak"]+=1
    save_all()
    bot.answer_callback_query(c.id,f"üî• –°—Ç—Ä–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –¢–µ–ø–µ—Ä—å {u['daily_streak']} –¥–Ω–µ–π. –ü–æ—Ç—Ä–∞—á–µ–Ω–æ {cost} üåë",show_alert=True)

# ---------------- –∫—É–±—ã ----------------
@bot.message_handler(func=lambda m: is_cmd(m.text,"–∫—É–±—ã"))
def dice(m):
    args=m.text.split()
    if len(args)!=3:
        bot.send_message(m.chat.id,".–∫—É–±—ã —Å—Ç–∞–≤–∫–∞ —á–∏—Å–ª–æ(1-6)")
        return
    try:
        bet = int(args[1])
        num = int(args[2])
    except:
        return
    u = get(uid(m))
    if u["coins"] < bet or not 1 <= num <= 6: return
    roll = random.randint(1, 6)
    if roll == num:
        win = int(bet * 1.15)
        u["coins"] += win
        text = f"üé≤ –í—ã–ø–∞–ª–æ {roll}\n‚úÖ –ü–æ–±–µ–¥–∞! +{win}"
    else:
        u["coins"] -= bet
        text = f"üé≤ –í—ã–ø–∞–ª–æ {roll}\n‚ùå –ü—Ä–æ–∏–≥—Ä—ã—à -{bet}"
    save_all()
    bot.send_message(m.chat.id, text)


# ---------------- –ø–∏–Ω–≥ ----------------
@bot.message_handler(func=lambda m: is_cmd(m.text, "–ø–∏–Ω–≥"))
def ping(m):
    start = time.time()
    msg = bot.send_message(m.chat.id, "üì° –ü—Ä–æ–≤–µ—Ä–∫–∞...")
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton("üîÑ –û–±–Ω–æ–≤–∏—Ç—å", callback_data="ping"))
    latency = int((time.time() - start) * 1000)
    bot.edit_message_text(f"üì° –ü–û–ù–ì\n‚ö°Ô∏è {latency} ms", m.chat.id, msg.message_id, reply_markup=kb)


@bot.callback_query_handler(func=lambda c: c.data == "ping")
def ping_cb(c):
    latency = random.randint(20, 80)
    bot.edit_message_text(f"üì° –ü–û–ù–ì\n‚ö°Ô∏è {latency} ms", c.message.chat.id, c.message.message_id,
                          reply_markup=c.message.reply_markup)


# ---------------- –¥–æ ----------------
@bot.message_handler(func=lambda m: is_cmd(m.text, "–¥–æ"))
def to(m):
    parts = m.text.split(maxsplit=1)
    if len(parts) < 2:
        bot.send_message(m.chat.id, ".–¥–æ –Ω–≥ | –ª–µ—Ç–æ | 31.12")
        return
    now = time.time()
    y = time.localtime().tm_year
    arg = parts[1]
    if arg in ("–Ω–≥", "–Ω–æ–≤—ã–π –≥–æ–¥"):
        t = time.strptime(f"01.01.{y + 1}", "%d.%m.%Y")
        name = "–ù–æ–≤–æ–≥–æ –≥–æ–¥–∞"
    else:
        try:
            d, mo = map(int, arg.split("."))
            t = time.strptime(f"{d:02}.{mo:02}.{y}", "%d.%m.%Y")
            name = arg
        except:
            bot.send_message(m.chat.id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç")
            return
    days = int((time.mktime(t) - now) // 86400)
    bot.send_message(m.chat.id, f"‚è≥ –î–æ {name}\n–û—Å—Ç–∞–ª–æ—Å—å –¥–Ω–µ–π: {days}")


# ---------------- —Ç–æ–ø ----------------
@bot.message_handler(func=lambda m: is_cmd(m.text, "—Ç–æ–ø"))
def top(m):
    top_users = sorted(users.items(), key=lambda x: x[1]["coins"], reverse=True)[:10]

    text = "üèÜ <b>–¢–æ–ø –ø–æ –∫–æ–∏–Ω–∞–º</b>\n\n"
    for i, (u_id, data) in enumerate(top_users, 1):
        try:
            chat = bot.get_chat(int(u_id))
            name = chat.first_name or "–ë–µ–∑ –∏–º–µ–Ω–∏"
        except:
            name = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"

        text += f"{i}. <a href='tg://user?id={u_id}'>{name}</a> ‚Äî {data['coins']} üåë\n"

    bot.send_message(
        m.chat.id,
        text,
        parse_mode="HTML",
        disable_web_page_preview=True
    )


# ---------------- –ø–æ–∏—Å–∫ ----------------
@bot.message_handler(func=lambda m: is_cmd(m.text, "–ø–æ–∏—Å–∫"))
def search(m):
    q = m.text.split(maxsplit=1)
    if len(q) < 2: return
    query = urllib.parse.quote(q[1])
    url = f"https://www.google.com/search?q={query}"
    kb = types.InlineKeyboardMarkup()
    kb.add(types.InlineKeyboardButton("üîé –û—Ç–∫—Ä—ã—Ç—å Google", url=url))
    bot.send_message(m.chat.id, f"üîé –ü–æ–∏—Å–∫: {q[1]}", reply_markup=kb)


# ---------------- —Ä–µ—à–∏ ----------------
@bot.message_handler(func=lambda m: is_cmd(m.text, "—Ä–µ—à–∏"))
def solve(m):
    try:
        expr = m.text.split(maxsplit=1)[1].replace("^", "**")
        x = sp.symbols("x")
        if "=" in expr:
            left, right = expr.split("=")
            sol = sp.solve(sp.Eq(sp.sympify(left), sp.sympify(right)))
            bot.send_message(m.chat.id, f"üë©üèº‚Äçüè´ –†–µ—à–µ–Ω–∏–µ:\n{x}={sol}")
        else:
            res = sp.sympify(expr)
            bot.send_message(m.chat.id, f"üë©üèº‚Äçüè´ –û—Ç–≤–µ—Ç:\n{res}")
    except:
        bot.send_message(m.chat.id, "‚ùå –û—à–∏–±–∫–∞ –≤ –ø—Ä–∏–º–µ—Ä–µ")

# ---------------- –∞–¥–º–∏–Ω ----------------
@bot.message_handler(func=lambda m: is_cmd(m.text, "–≤—ã–¥–∞—Ç—å"))
def admin_give(m):
    if not is_admin(m): return
    args = m.text.split()
    if len(args) < 3: bot.send_message(m.chat.id, "–ò—Å–ø–æ–ª—å–∑—É–π: .–≤—ã–¥–∞—Ç—å @user 100"); return
    try:
        amount = int(args[2])
    except:
        bot.send_message(m.chat.id, "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ"); return
    try:
        user = bot.get_chat(args[1])
    except:
        bot.send_message(m.chat.id, "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"); return
    u = get(str(user.id))
    u["coins"] += amount
    save_all()
    bot.send_message(m.chat.id, f"‚úÖ –í—ã–¥–∞–Ω–æ {amount} üåë –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.username}")
    bot.send_message(user.id, f"üì¢ –ê–¥–º–∏–Ω –≤—ã–¥–∞–ª –≤–∞–º {amount} üåë")


@bot.message_handler(func=lambda m: is_cmd(m.text, "–æ—Ç–æ–±—Ä–∞—Ç—å"))
def admin_take(m):
    if not is_admin(m): return
    args = m.text.split()
    if len(args) < 3: bot.send_message(m.chat.id, "–ò—Å–ø–æ–ª—å–∑—É–π: .–æ—Ç–æ–±—Ä–∞—Ç—å @user 100"); return
    try:
        amount = int(args[2])
    except:
        bot.send_message(m.chat.id, "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ"); return
    try:
        user = bot.get_chat(args[1])
    except:
        bot.send_message(m.chat.id, "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω"); return
    u = get(str(user.id))
    u["coins"] = max(u["coins"] - amount, 0)
    save_all()
    bot.send_message(m.chat.id, f"‚úÖ –û—Ç–æ–±—Ä–∞–Ω–æ {amount} üåë —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user.username}")
    bot.send_message(user.id, f"üì¢ –ê–¥–º–∏–Ω –∑–∞–±—Ä–∞–ª —É –≤–∞—Å {amount} üåë")

# ---------------- –∞–¥–≤–µ–Ω—Ç ----------------
@bot.message_handler(func=lambda m: is_cmd(m.text, "–∞–¥–≤–µ–Ω—Ç"))
def advent_cmd(m):
    u = get(uid(m))
    last = max(u["advent"], default=1)
    page = (last - 1) // ADVENT_PER_PAGE

    kb = build_advent_kb(uid(m), page)
    bot.send_message(
        m.chat.id,
        "üéÑ –ê–¥–≤–µ–Ω—Ç-–∫–∞–ª–µ–Ω–¥–∞—Ä—å\n–í—ã–±–∏—Ä–∞–π –¥–µ–Ω—å:",
        reply_markup=kb
    )

@bot.callback_query_handler(func=lambda c: c.data.startswith("advent:"))
def advent_cb(c):
    _, day, owner = c.data.split(":")
    day = int(day)
    if str(c.from_user.id) != owner:
        bot.answer_callback_query(c.id, "‚ùå –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å", show_alert=True)
        return
    u = get(owner)
    today = time.localtime().tm_mday
    if day > today:
        bot.answer_callback_query(c.id, "‚è≥ –≠—Ç–æ—Ç –¥–µ–Ω—å –µ—â—ë –Ω–µ –Ω–∞—Å—Ç—É–ø–∏–ª", show_alert=True)
        return
    if day in u["advent"]:
        bot.answer_callback_query(c.id, "‚úÖ –í—ã —É–∂–µ –∑–∞–±–∏—Ä–∞–ª–∏ —ç—Ç—É –Ω–∞–≥—Ä–∞–¥—É", show_alert=True)
        return
    reward = random.randint(30, 80)
    u["coins"] += reward
    u["advent"].append(day)
    save_all()
    bot.answer_callback_query(c.id, f"üéÅ –í—ã –ø–æ–ª—É—á–∏–ª–∏ {reward} üåë", show_alert=True)
ADVENT_PER_PAGE = 5

def build_advent_kb(user_id, page):
    u = get(user_id)
    kb = types.InlineKeyboardMarkup()

    start = page * ADVENT_PER_PAGE + 1
    end = min(start + ADVENT_PER_PAGE - 1, 31)

    buttons = []
    for day in range(start, end + 1):
        if day in u["advent"]:
            text = f"‚úÖ {day}"
            cb = f"advent_done:{day}:{user_id}:{page}"
        else:
            if day == 31:
                text = f"üëë {day}"
            else:
                text = f"üéÅ {day}"
            cb = f"advent_take:{day}:{user_id}:{page}"

        buttons.append(
            types.InlineKeyboardButton(text, callback_data=cb)
        )

    # üîπ –≤—Å–µ –¥–Ω–∏ –í –û–î–ò–ù –†–Ø–î
    kb.row(*buttons)

    # üîπ –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    nav = []
    if page > 0:
        nav.append(types.InlineKeyboardButton("‚¨ÖÔ∏è", callback_data=f"advent_page:{page-1}:{user_id}"))
    if end < 31:
        nav.append(types.InlineKeyboardButton("‚û°Ô∏è", callback_data=f"advent_page:{page+1}:{user_id}"))

    if nav:
        kb.row(*nav)

    return kb

@bot.callback_query_handler(func=lambda c: c.data.startswith("advent_page:"))
def advent_page_cb(c):
    _, page, owner = c.data.split(":")
    if str(c.from_user.id) != owner:
        bot.answer_callback_query(c.id, "‚ùå –≠—Ç–∞ –∫–Ω–æ–ø–∫–∞ –Ω–µ –¥–ª—è –≤–∞—Å", show_alert=True)
        return

    kb = build_advent_kb(owner, int(page))
    bot.edit_message_reply_markup(
        c.message.chat.id,
        c.message.message_id,
        reply_markup=kb
    )

@bot.callback_query_handler(func=lambda c: c.data.startswith("advent_take:"))
def advent_take_cb(c):
    _, day, owner, page = c.data.split(":")
    day = int(day)
    page = int(page)

    if str(c.from_user.id) != owner:
        bot.answer_callback_query(c.id, "‚ùå –≠—Ç–æ –Ω–µ –≤–∞—à–∞ –∫–Ω–æ–ø–∫–∞", show_alert=True)
        return

    u = get(owner)
    today = time.localtime().tm_mday

    if day > today:
        bot.answer_callback_query(c.id, "‚è≥ –≠—Ç–æ—Ç –¥–µ–Ω—å –µ—â—ë –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω", show_alert=True)
        return

    if day in u["advent"]:
        bot.answer_callback_query(c.id, "‚úÖ –£–∂–µ –ø–æ–ª—É—á–µ–Ω–æ", show_alert=True)
        return

    # üéÅ –Ω–∞–≥—Ä–∞–¥—ã
    if day == 31:
        coins = random.randint(1000, 2000)
        text = f"üëë –õ–ï–ì–ï–ù–î–ê–†–ù–ê–Ø –ù–ê–ì–†–ê–î–ê!\n+{coins} üåë"
    else:
        coins = random.randint(120, 220)
        text = f"üéÅ +{coins} üåë"

    u["coins"] += coins
    u["advent"].append(day)
    save(users)

    bot.answer_callback_query(c.id, text, show_alert=True)

    kb = build_advent_kb(owner, page)
    bot.edit_message_reply_markup(
        c.message.chat.id,
        c.message.message_id,
        reply_markup=kb
    )

bot.polling(none_stop=True)
